# FastAPI + SQLAlchemy + Alembic - –£—á–µ–±–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Python419

API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞–º–∏, –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∏ —Ç–µ–≥–∞–º–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö SQLite.

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

**Python 3.10+** —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```powershell
# –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
python -m venv venv

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è (PowerShell)
.\venv\Scripts\Activate.ps1

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install -r requirements.txt
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª `.env.example` –≤ `.env`:

   ```powershell
   Copy-Item .env.example .env
   ```

2. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `.env` –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

   ```env
   # Telegram bot (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
   TELEGRAM_BOT_API_KEY=your_bot_api_key
   TELEGRAM_USER_ID=your_user_id
   
   # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö SQLite
   DATABASE_URL=sqlite+aiosqlite:///./test.db
   ```

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

**‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û**: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ Alembic (–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –º–∏–≥—Ä–∞—Ü–∏–π).

```powershell
# –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
python -c "import sqlite3; sqlite3.connect('test.db').close()"

# –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (—Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã)
alembic upgrade head

# –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
alembic current
```

**–ß—Ç–æ —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:**

- `categories` - –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤
- `tags` - —Ç–µ–≥–∏ –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤
- `products` - —Ç–æ–≤–∞—Ä—ã —Å —Ü–µ–Ω–∞–º–∏ –≤ —à–º–µ–∫–ª—è—Ö –∏ —Ñ–ª—É—Ä–±–æ
- `product_tag_association` - —Å–≤—è–∑—å –º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º (M2M) –º–µ–∂–¥—É —Ç–æ–≤–∞—Ä–∞–º–∏ –∏ —Ç–µ–≥–∞–º–∏
- `alembic_version` - —Å–ª—É–∂–µ–±–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤–µ—Ä—Å–∏–π —Å—Ö–µ–º—ã –ë–î

### –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```powershell
# –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
.\venv\Scripts\Activate.ps1

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ FastAPI —Å–µ—Ä–≤–µ—Ä
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

## üìù –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ API

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞, API –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: `http://localhost:8000`

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API

- **Swagger UI**: <http://localhost:8000/docs>
- **ReDoc**: <http://localhost:8000/redoc>

### –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤

#### 1. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

```http
GET http://localhost:8000/categories/
```

#### 2. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é

```http
POST http://localhost:8000/categories/
Content-Type: application/json

{
  "name": "–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞"
}
```

#### 3. –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ç–µ–≥–∏

```http
GET http://localhost:8000/tags/
```

#### 4. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–µ–≥

```http
POST http://localhost:8000/tags/
Content-Type: application/json

{
  "name": "–ù–æ–≤–∏–Ω–∫–∞"
}
```

#### 5. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–æ–≤–∞—Ä–æ–≤

```http
GET http://localhost:8000/products/
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:**

- `?name=rick` - –ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏
- `?category_id=1` - —Ñ–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- `?tag_ids=1,2` - —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º (–Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
- `?min_price_shmeckles=10&max_price_shmeckles=100` - —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ü–µ–Ω–µ –≤ —à–º–µ–∫–ª—è—Ö

#### 6. –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–≤–∞—Ä –ø–æ ID

```http
GET http://localhost:8000/products/1
```

#### 7. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä

```http
POST http://localhost:8000/products/
Content-Type: application/json

{
  "name": "–ü–æ—Ä—Ç–∞–ª—å–Ω–∞—è –ø—É—à–∫–∞",
  "description": "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ø–æ—Ä—Ç–∞–ª—å–Ω–∞—è –ø—É—à–∫–∞ –æ—Ç Rick",
  "image_url": "https://example.com/portal-gun.jpg",
  "price_shmeckles": 250.5,
  "price_flurbos": 180.0,
  "category_id": 1,
  "tag_ids": [1, 2]
}
```

#### 8. –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–≤–∞—Ä

```http
PUT http://localhost:8000/products/1
Content-Type: application/json

{
  "name": "–£–ª—É—á—à–µ–Ω–Ω–∞—è –ø–æ—Ä—Ç–∞–ª—å–Ω–∞—è –ø—É—à–∫–∞",
  "price_shmeckles": 300.0
}
```

#### 9. –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä

```http
DELETE http://localhost:8000/products/1
```

---

## üóÑÔ∏è –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∏ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **SQLAlchemy 2.0** —Å async –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏ **Alembic** –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π.

**–ú–æ–¥–µ–ª–∏ (tables):**

1. **Category** (One-to-Many —Å Product)
   - `id` - PRIMARY KEY
   - `name` - —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è)

2. **Tag** (Many-to-Many —Å Product)
   - `id` - PRIMARY KEY
   - `name` - —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ç–µ–≥–∞ (–∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è)

3. **Product**
   - `id` - PRIMARY KEY
   - `name` - –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è –¥–ª—è –ø–æ–∏—Å–∫–∞)
   - `description` - –æ–ø–∏—Å–∞–Ω–∏–µ (TEXT, nullable)
   - `image_url` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (nullable)
   - `price_shmeckles` - —Ü–µ–Ω–∞ –≤ —à–º–µ–∫–ª—è—Ö (–∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è)
   - `price_flurbos` - —Ü–µ–Ω–∞ –≤ —Ñ–ª—É—Ä–±–æ (–∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è)
   - `category_id` - FOREIGN KEY –Ω–∞ categories (nullable, ON DELETE SET NULL)

4. **product_tag_association** (–∞—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞)
   - `product_id` - FOREIGN KEY –Ω–∞ products (ON DELETE CASCADE)
   - `tag_id` - FOREIGN KEY –Ω–∞ tags (ON DELETE CASCADE)

### –ö–æ–º–∞–Ω–¥—ã Alembic

#### –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

```powershell
# –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é –ë–î
alembic current

# –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –≤—Å–µ—Ö –º–∏–≥—Ä–∞—Ü–∏–π
alembic history

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (–æ–±–Ω–æ–≤–∏—Ç—å –ë–î –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏)
alembic upgrade head

# –û—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –º–∏–≥—Ä–∞—Ü–∏—é
alembic downgrade -1

# –û—Ç–∫–∞—Ç–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (–ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ë–î)
alembic downgrade base
```

#### –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π

–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–æ–¥–µ–ª–µ–π –≤ `models/product.py`:

```powershell
# 1. –ò–∑–º–µ–Ω–∏—Ç—å –º–æ–¥–µ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –≤ –∫–ª–∞—Å—Å Product)

# 2. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é (–∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è)
alembic revision --autogenerate -m "Add stock_quantity to products"

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ alembic/versions/xxxxx_add_stock_quantity.py

# 4. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
alembic upgrade head
```

#### –ü—Ä–æ—Å–º–æ—Ç—Ä SQL –±–µ–∑ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

```powershell
# –ü–æ–∫–∞–∑–∞—Ç—å SQL –∫–æ–º–∞–Ω–¥—ã –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
alembic upgrade head --sql
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î

```powershell
# –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
python -c "import sqlite3; conn = sqlite3.connect('test.db'); print([t[0] for t in conn.execute('SELECT name FROM sqlite_master WHERE type=\"table\"').fetchall()]); conn.close()"

# –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
python -c "import sqlite3; conn = sqlite3.connect('test.db'); print(conn.execute('PRAGMA table_info(products)').fetchall()); conn.close()"
```

### –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ë–î

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:

```powershell
# 1. –û—Ç–∫–∞—Ç–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏
alembic downgrade base

# 2. –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª –ë–î
del test.db

# 3. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞)
del alembic\versions\*.py
echo. > alembic\versions\__init__.py

# 4. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª –ë–î
python -c "import sqlite3; sqlite3.connect('test.db').close()"

# 5. –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é
alembic revision --autogenerate -m "Initial migration"

# 6. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
alembic upgrade head

# 7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
alembic current
```

---

## üîß –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```text
fast_api_419/
‚îú‚îÄ‚îÄ main.py                  # –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ FastAPI
‚îú‚îÄ‚îÄ data.py                  # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã)
‚îú‚îÄ‚îÄ requirements.txt         # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python
‚îú‚îÄ‚îÄ .env                     # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Å–æ–∑–¥–∞—Ç—å –∏–∑ .env.example)
‚îú‚îÄ‚îÄ .env.example             # –ü—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ test.db                  # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö SQLite (—Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
‚îú‚îÄ‚îÄ alembic.ini              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Alembic
‚îÇ
‚îú‚îÄ‚îÄ core/                    # –Ø–¥—Ä–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ config.py            # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (pydantic-settings)
‚îÇ   ‚îî‚îÄ‚îÄ database.py          # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î, async engine, —Å–µ—Å—Å–∏–∏
‚îÇ
‚îú‚îÄ‚îÄ models/                  # ORM –º–æ–¥–µ–ª–∏ SQLAlchemy
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ base.py              # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å DeclarativeBase
‚îÇ   ‚îî‚îÄ‚îÄ product.py           # –ú–æ–¥–µ–ª–∏ Category, Tag, Product + –∞—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
‚îÇ
‚îú‚îÄ‚îÄ schemas/                 # Pydantic —Å—Ö–µ–º—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ product.py           # –°—Ö–µ–º—ã –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤ API
‚îÇ
‚îú‚îÄ‚îÄ routes/                  # –ú–∞—Ä—à—Ä—É—Ç—ã API (endpoints)
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ categories.py        # CRUD –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ tags.py              # CRUD –¥–ª—è —Ç–µ–≥–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ products.py          # CRUD –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤
‚îÇ
‚îú‚îÄ‚îÄ utils/                   # –£—Ç–∏–ª–∏—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ telegram_bot.py      # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram
‚îÇ
‚îî‚îÄ‚îÄ alembic/                 # –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    ‚îú‚îÄ‚îÄ env.py               # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è Alembic (async)
    ‚îú‚îÄ‚îÄ script.py.mako       # –®–∞–±–ª–æ–Ω –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π
    ‚îî‚îÄ‚îÄ versions/            # –§–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π
        ‚îî‚îÄ‚îÄ xxxxx_initial_migration.py
```

---

## ‚ö†Ô∏è –†–µ—à–µ–Ω–∏–µ —Ç–∏–ø–∏—á–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞**: Alembic - —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –º–∏–≥—Ä–∞—Ü–∏–π, –æ–Ω **–ù–ï —Å–æ–∑–¥–∞—ë—Ç —Ñ–∞–π–ª –ë–î**!

**–†–µ—à–µ–Ω–∏–µ**:

```powershell
# –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –ë–î –≤—Ä—É—á–Ω—É—é
python -c "import sqlite3; sqlite3.connect('test.db').close()"

# –ó–∞—Ç–µ–º –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
alembic upgrade head
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ—Å–ª–µ `alembic upgrade head` —Å–æ–∑–¥–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ `alembic_version`

**–ü—Ä–∏—á–∏–Ω–∞**: –ú–∏–≥—Ä–∞—Ü–∏—è **–ø—É—Å—Ç–∞—è** –∏–ª–∏ **–¥–≤–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏**.

**–†–µ—à–µ–Ω–∏–µ**:

```powershell
# –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å
alembic downgrade base
del test.db
del alembic\versions\*.py
echo. > alembic\versions\__init__.py

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å
python -c "import sqlite3; sqlite3.connect('test.db').close()"
alembic revision --autogenerate -m "Initial migration"
alembic upgrade head

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
alembic current
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—É—Å—Ç–æ–π (—Ç–æ–ª—å–∫–æ `pass` –≤ `upgrade()`)

**–ü—Ä–∏—á–∏–Ω–∞**: Alembic –Ω–µ –≤–∏–¥–∏—Ç –º–æ–¥–µ–ª–∏!

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `alembic/env.py`:

```python
# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã:
from models.base import Base
from models.product import Product, Category, Tag, product_tag_association

# –ò —ç—Ç–∞ —Å—Ç—Ä–æ–∫–∞:
target_metadata = Base.metadata
```

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –≤ `alembic/env.py`

**–†–µ—à–µ–Ω–∏–µ**: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞:

```powershell
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤
python -c "from models.base import Base; from models.product import Product; print('OK')"
```

### –ü—Ä–æ–±–ª–µ–º–∞: `ModuleNotFoundError: No module named 'models'`

**–†–µ—à–µ–Ω–∏–µ**: –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ **–∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞**, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–∞–ø–∫–∞ `models/`.

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ `"Target database is not up to date"`

**–†–µ—à–µ–Ω–∏–µ**:

```powershell
# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏
alembic upgrade head
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ –æ—à–∏–±–∫–∞ "FOREIGN KEY constraint failed"

**–ü—Ä–∏—á–∏–Ω–∞**: –£–∫–∞–∑–∞–Ω –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `category_id` –∏–ª–∏ `tag_id`.

**–†–µ—à–µ–Ω–∏–µ**: –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã.

---

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤

–í `core/database.py` –∏–∑–º–µ–Ω–∏—Ç–µ:

```python
# –ë—ã–ª–æ
engine = create_async_engine(DATABASE_URL, echo=False)

# –°—Ç–∞–ª–æ (–≤–∫–ª—é—á–∞–µ—Ç –ª–æ–≥–∏ SQL)
engine = create_async_engine(DATABASE_URL, echo=True)
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î

```python
python -c "import asyncio; from core.database import engine; asyncio.run(engine.dispose()); print('–ë–î OK')"
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ë–î

```powershell
# –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
python -c "import sqlite3; conn = sqlite3.connect('test.db'); print(conn.execute('SELECT * FROM products').fetchall()); conn.close()"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π –≤ –ë–î

```powershell
python -c "import sqlite3; conn = sqlite3.connect('test.db'); print(conn.execute('SELECT * FROM alembic_version').fetchall()); conn.close()"
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [SQLAlchemy 2.0 Documentation](https://docs.sqlalchemy.org/en/20/)
- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [Pydantic Documentation](https://docs.pydantic.dev/)
- [Async SQLAlchemy Guide](https://docs.sqlalchemy.org/en/20/orm/extensions/asyncio.html)

---

## üíæ –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤

### 1. Alembic –ù–ï —Å–æ–∑–¥–∞—ë—Ç —Ñ–∞–π–ª –ë–î

**–ó–∞–ø–æ–º–Ω–∏—Ç–µ**: Alembic - —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –º–∏–≥—Ä–∞—Ü–∏–π —Å—Ö–µ–º—ã, –∞ –ù–ï —Å–æ–∑–¥–∞–Ω–∏—è –ë–î.

```powershell
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
alembic upgrade head  # –ù–∏—á–µ–≥–æ –Ω–µ —Å–æ–∑–¥–∞—Å—Ç—Å—è!

# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Å–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—Ç—å –ë–î, –ø–æ—Ç–æ–º –º–∏–≥—Ä–∞—Ü–∏–∏
python -c "import sqlite3; sqlite3.connect('test.db').close()"
alembic upgrade head
```

### 2. –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–∏–≥—Ä–∞—Ü–∏–π

–ü–æ—Å–ª–µ `alembic revision --autogenerate` **–æ—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏** –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

```python
def upgrade() -> None:
    pass  # ‚ùå –ü–õ–û–•–û - –º–∏–≥—Ä–∞—Ü–∏—è –ø—É—Å—Ç–∞—è!
    
def upgrade() -> None:
    op.create_table('products', ...)  # ‚úÖ –•–û–†–û–®–û - –µ—Å—Ç—å –∫–æ–º–∞–Ω–¥—ã
```

### 3. –ü–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ

```text
1. –°–æ–∑–¥–∞—Ç—å venv –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
2. –°–æ–∑–¥–∞—Ç—å .env —Ñ–∞–π–ª
3. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –ë–î (python -c "import sqlite3...")
4. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (alembic upgrade head)
5. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä (uvicorn main:app --reload)
```

### 4. –ü–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–æ–¥–µ–ª–µ–π

```text
1. –ò–∑–º–µ–Ω–∏—Ç—å –º–æ–¥–µ–ª—å –≤ models/product.py
2. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é (alembic revision --autogenerate -m "...")
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ alembic/versions/
4. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é (alembic upgrade head)
5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
```

### 5. –ß—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ –≤—Å—ë —Å–ª–æ–º–∞–ª–æ—Å—å

```powershell
# –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å (–ø–æ—Ç–µ—Ä—è–µ—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ!)
alembic downgrade base
del test.db
del alembic\versions\*.py
echo. > alembic\versions\__init__.py

# –ù–∞—á–∞—Ç—å —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞
python -c "import sqlite3; sqlite3.connect('test.db').close()"
alembic revision --autogenerate -m "Initial migration"
alembic upgrade head
```

### 6. –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π —á–µ–∫–ª–∏—Å—Ç

‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ?  
‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã? (`pip list`)  
‚úÖ –§–∞–π–ª `.env` —Å–æ–∑–¥–∞–Ω –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω?  
‚úÖ –§–∞–π–ª `test.db` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?  
‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã? (`alembic current`)  
‚úÖ –¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã? (–ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ python -c "...")  
‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8000?  

---

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

–£—á–µ–±–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã FastAPI —Å SQLAlchemy –∏ Alembic.
