# üìö –ó–∞–Ω—è—Ç–∏–µ ‚Ññ2: Cookie-Based Authentication (–ß–∞—Å—Ç—å 6)

## –ö–æ–º–º–∏—Ç: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω—Å–∫–∏—Ö —Ä–æ—É—Ç–æ–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞–º–∏

---

## üéØ –ß—Ç–æ –º—ã –¥–µ–ª–∞–ª–∏

–í –ø—Ä–µ–¥—ã–¥—É—â–µ–π —á–∞—Å—Ç–∏ –º—ã —Å–æ–∑–¥–∞–ª–∏ HTML-—Ñ–æ—Ä–º—É –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤. –¢–µ–ø–µ—Ä—å –Ω—É–∂–µ–Ω –±—ç–∫–µ–Ω–¥-–∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —ç—Ç—É —Ñ–æ—Ä–º—É –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç: –ø–æ–∫–∞–∂–µ—Ç –µ—ë –ø—Ä–∏ GET-–∑–∞–ø—Ä–æ—Å–µ, –ø—Ä–∏–º–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ POST-–∑–∞–ø—Ä–æ—Å–µ, –ø—Ä–æ–≤–µ—Ä–∏—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞, —Å–æ—Ö—Ä–∞–Ω–∏—Ç —Ç–æ–≤–∞—Ä –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.

–≠—Ç–∏ —Ä–æ—É—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º. –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã. –ù–∞–º –Ω—É–∂–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ ‚Äî dependency, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–±—Ä–æ—Å–∏—Ç –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ superuser.

–¢–∞–∫–∂–µ –≤–∞–∂–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å FormData. HTML-—Ñ–æ—Ä–º—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏. `category_id` –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫–∞–∫ `"5"`, –∞ –Ω–µ `5`. –ß–µ–∫–±–æ–∫—Å—ã —Ç–µ–≥–æ–≤ –º–æ–≥—É—Ç –≤–æ–æ–±—â–µ –Ω–µ –ø—Ä–∏–π—Ç–∏, –µ—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω. –ù—É–∂–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–∞—Ä—Å–∏—Ç—å –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ.

---

## üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥—É–ª—è routes/admin.py

–ú—ã —Å–æ–∑–¥–∞–ª–∏ –Ω–æ–≤—ã–π —Ñ–∞–π–ª `routes/admin.py` –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∞–¥–º–∏–Ω—Å–∫–∏—Ö —Ä–æ—É—Ç–æ–≤. –≠—Ç–æ –ª–æ–≥–∏—á–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ: `routes/pages.py` –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü, `routes/auth.py` –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, `routes/admin.py` –¥–ª—è –∞–¥–º–∏–Ω–∫–∏.

–§–∞–π–ª –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –∏–º–ø–æ—Ä—Ç–∞ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π. –ù–∞–º –Ω—É–∂–µ–Ω `APIRouter` –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —Ä–æ—É—Ç–æ–≤, `Form` –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ FormData, `Depends` –¥–ª—è dependency injection, –∏ —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î.

–°–æ–∑–¥–∞—ë–º —Ä–æ—É—Ç–µ—Ä —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `/admin` –∏ —Ç–µ–≥–æ–º –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:

```python
router = APIRouter(prefix="/admin", tags=["Admin"])
```

–¢–µ–ø–µ—Ä—å –≤—Å–µ —Ä–æ—É—Ç—ã –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—é—Ç –ø—Ä–µ—Ñ–∏–∫—Å. –†–æ—É—Ç `@router.get("/products/new")` –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ `/admin/products/new`.

---

## üõ°Ô∏è –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞

–ü–µ—Ä–µ–¥ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π —Ä–æ—É—Ç–æ–≤ —Å–æ–∑–¥–∞—ë–º —Ñ—É–Ω–∫—Ü–∏—é-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç superuser —Å—Ç–∞—Ç—É—Å:

```python
async def require_superuser(
    user: User | None = Depends(get_current_user_from_cookie)
) -> User:
    if not user:
        raise HTTPException(401, "–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è")
    if not user.is_superuser:
        raise HTTPException(403, "–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω: —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤")
    return user
```

–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞—à—É —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å `get_current_user_from_cookie`, –∫–æ—Ç–æ—Ä–∞—è –∏–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ cookie. –ó–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–µ—Ç –¥–≤–µ –ø—Ä–æ–≤–µ—Ä–∫–∏.

–ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ `user` —Ä–∞–≤–µ–Ω `None`, –∑–Ω–∞—á–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –≤–æ–æ–±—â–µ. –í—ã–±—Ä–∞—Å—ã–≤–∞–µ–º HTTP 401 (Unauthorized). –≠—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –∫–ª–∏–µ–Ω—Ç—É: "–ù—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π—Ç–∏".

–í—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –Ω–æ `user.is_superuser` —Ä–∞–≤–µ–Ω `False`, –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º HTTP 403 (Forbidden). –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç: "–¢—ã –æ–ø–æ–∑–Ω–∞–Ω, –Ω–æ —É —Ç–µ–±—è –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ".

–†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É 401 –∏ 403 –≤–∞–∂–Ω–∞. 401 –≥–æ–≤–æ—Ä–∏—Ç: "–ü–æ–ø—Ä–æ–±—É–π –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è". 403 –≥–æ–≤–æ—Ä–∏—Ç: "–î–∞–∂–µ –µ—Å–ª–∏ —Ç—ã –∞–≤—Ç–æ—Ä–∏–∑—É–µ—à—å—Å—è, –¥–æ—Å—Ç—É–ø–∞ –Ω–µ –±—É–¥–µ—Ç". –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å–µ–º–∞–Ω—Ç–∏–∫–∞ HTTP.

–í–æ–∑–≤—Ä–∞—â–∞–µ–º `user`, —á—Ç–æ–±—ã —Ä–æ—É—Ç—ã –º–æ–≥–ª–∏ –µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å. –¢–µ–ø–µ—Ä—å –≤ –∫–∞–∂–¥–æ–º –∞–¥–º–∏–Ω—Å–∫–æ–º —Ä–æ—É—Ç–µ –≤–º–µ—Å—Ç–æ:

```python
user: User | None = Depends(get_current_user_from_cookie)
if not user or not user.is_superuser:
    raise HTTPException(403)
```

–ü–∏—à–µ–º –ø—Ä–æ—Å—Ç–æ:

```python
user: User = Depends(require_superuser)
```

–ö–æ–¥ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —á–∏—â–µ, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–∞. –ï—Å–ª–∏ –º—ã –∑–∞—Ö–æ—Ç–∏–º –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–≤–µ—Ä–∫—É email –¥–æ–º–µ–Ω–∞), –∏–∑–º–µ–Ω–∏–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É —Ñ—É–Ω–∫—Ü–∏—é.

---

## üìÑ –†–æ—É—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞

–ü–µ—Ä–≤—ã–π —Ä–æ—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—É—Å—Ç—É—é —Ñ–æ—Ä–º—É:

```python
@router.get("/products/new")
async def create_product_page(
    request: Request,
    user: User = Depends(require_superuser),
    session: AsyncSession = Depends(get_session)
):
    categories = await get_all_categories(session)
    tags = await get_all_tags(session)
    
    return templates.TemplateResponse("admin_product.html", {
        "request": request,
        "user": user,
        "product": None,  # –§–æ—Ä–º–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è
        "categories": categories,
        "tags": tags
    })
```

–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ `user: User = Depends(require_superuser)` ‚Äî —ç—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç —Ä–æ—É—Ç. –ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–π—Ç–∏ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ –±–µ–∑ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞, –æ–Ω –ø–æ–ª—É—á–∏—Ç –æ—à–∏–±–∫—É –µ—â—ë –¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ–ª–∞ —Ñ—É–Ω–∫—Ü–∏–∏.

–ú—ã –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Ç–µ–≥–∏ –∏–∑ –ë–î, —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∏ —á–µ–∫–±–æ–∫—Å—ã –≤ —Ñ–æ—Ä–º–µ. –ü–µ—Ä–µ–¥–∞—ë–º `product=None`, —á—Ç–æ —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —à–∞–±–ª–æ–Ω—É: —ç—Ç–æ —Ñ–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è, –ø–æ–ª—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏.

–¢–∞–∫–∂–µ –ø–µ—Ä–µ–¥–∞—ë–º `user`, —á—Ç–æ–±—ã –Ω–∞–≤–±–∞—Ä –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è —Å email –∞–¥–º–∏–Ω–∞.

---

## üíæ –†–æ—É—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞

–í—Ç–æ—Ä–æ–π —Ä–æ—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç POST-–∑–∞–ø—Ä–æ—Å –æ—Ç —Ñ–æ—Ä–º—ã:

```python
@router.post("/products/new")
async def create_product(
    name: str = Form(...),
    description: str = Form(...),
    price_shmeckles: float = Form(...),
    price_flurbos: float = Form(...),
    image_url: str = Form(""),
    category_id: str = Form(...),
    tag_ids: list[int] = Form(default=[]),
    user: User = Depends(require_superuser),
    session: AsyncSession = Depends(get_session)
):
```

–ö–∞–∂–¥—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä —Å `Form(...)` —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª—é –≤ HTML-—Ñ–æ—Ä–º–µ. FastAPI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–∞—Ä—Å–∏—Ç FormData –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ç–∏–ø—ã.

–í–∞–∂–Ω–æ: `category_id: str = Form(...)` ‚Äî –º—ã –æ–±—ä—è–≤–ª—è–µ–º –∫–∞–∫ —Å—Ç—Ä–æ–∫—É, –ø–æ—Ç–æ–º—É —á—Ç–æ HTML-—Ñ–æ—Ä–º—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç –≤—Å—ë –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏. –î–∞–∂–µ –µ—Å–ª–∏ –≤ —Ñ–æ—Ä–º–µ `<option value="5">`, –±—Ä–∞—É–∑–µ—Ä –æ—Ç–ø—Ä–∞–≤–∏—Ç —Ç–µ–∫—Å—Ç `"5"`. –ú—ã –≤—Ä—É—á–Ω—É—é –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ int –ø–æ–∑–∂–µ.

–ü–∞—Ä–∞–º–µ—Ç—Ä `image_url: str = Form("")` –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞. –ï—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ, –º—ã –ø–æ–ª—É—á–∏–º `""`, –∞ –Ω–µ `None`. –≠—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –Ω–∞—à–µ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –≥–¥–µ `image_url` –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π.

–ü–∞—Ä–∞–º–µ—Ç—Ä `tag_ids: list[int] = Form(default=[])` ‚Äî —ç—Ç–æ –º–∞—Å—Å–∏–≤. –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω —á–µ–∫–±–æ–∫—Å –Ω–µ –≤—ã–±—Ä–∞–Ω, –±—Ä–∞—É–∑–µ—Ä –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª–µ `tag_ids` –≤–æ–æ–±—â–µ. `default=[]` –≥–æ–≤–æ—Ä–∏—Ç FastAPI: –µ—Å–ª–∏ –ø–æ–ª—è –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–π –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫.

–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç ProductCreate:

```python
product_data = ProductCreate(
    name=name,
    description=description,
    price_shmeckles=price_shmeckles,
    price_flurbos=price_flurbos,
    image_url=image_url or None,  # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Üí None
    category_id=int(category_id),  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ int
    tag_ids=tag_ids
)
```

–í—ã—Ä–∞–∂–µ–Ω–∏–µ `image_url or None` –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –≤ `None`. –í Python –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ —ç—Ç–æ "falsy" –∑–Ω–∞—á–µ–Ω–∏–µ, –ø–æ—ç—Ç–æ–º—É `"" or None` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None`. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º–∏ —Å —Ç–µ–º, –∫–∞–∫ –º—ã —Ö—Ä–∞–Ω–∏–º NULL –≤ –ë–î.

`int(category_id)` –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Å—Ç—Ä–æ–∫—É `"5"` –≤ —á–∏—Å–ª–æ `5`. –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `"abc"`), –≤—ã–±—Ä–æ—Å–∏—Ç—Å—è `ValueError`, –∫–æ—Ç–æ—Ä—É—é FastAPI –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤ HTTP 422.

–°–æ–∑–¥–∞—ë–º —Ç–æ–≤–∞—Ä –≤ –ë–î:

```python
await create_product_in_db(session, product_data)
await session.commit()
```

–§—É–Ω–∫—Ü–∏—è `create_product_in_db` —Å–æ–∑–¥–∞—ë—Ç –æ–±—ä–µ–∫—Ç `ProductORM`, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–≤—è–∑–∏ —Å —Ç–µ–≥–∞–º–∏ —á–µ—Ä–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é —Ç–∞–±–ª–∏—Ü—É, –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ —Å–µ—Å—Å–∏—é. `session.commit()` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î.

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é:

```python
return RedirectResponse("/", status_code=303)
```

Status code 303 (See Other) –≥–æ–≤–æ—Ä–∏—Ç –±—Ä–∞—É–∑–µ—Ä—É: "–î–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã, –ø–µ—Ä–µ–π–¥–∏ –Ω–∞ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –º–µ—Ç–æ–¥–æ–º GET". –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–¥ –¥–ª—è POST-redirect-GET –ø–∞—Ç—Ç–µ—Ä–Ω–∞.

–ü–æ—á–µ–º—É –Ω–µ 302? –ü–æ—Ç–æ–º—É —á—Ç–æ 302 (Found) –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–µ–Ω ‚Äî –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã –ø–æ—Å–ª–µ –Ω–µ–≥–æ –¥–µ–ª–∞—é—Ç GET, –¥—Ä—É–≥–∏–µ –ø–æ–≤—Ç–æ—Ä—è—é—Ç POST. 303 —è–≤–Ω–æ —Ç—Ä–µ–±—É–µ—Ç GET, —á—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã.

---

## ‚úèÔ∏è –†–æ—É—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–¢—Ä–µ—Ç–∏–π —Ä–æ—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º—É, –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—É—é –¥–∞–Ω–Ω—ã–º–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–æ–≤–∞—Ä–∞:

```python
@router.get("/products/{product_id}/edit")
async def edit_product_page(
    product_id: int,
    request: Request,
    user: User = Depends(require_superuser),
    session: AsyncSession = Depends(get_session)
):
    product = await get_product_by_id(session, product_id)
    if not product:
        raise HTTPException(404, "–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–≥–∏ —Å selectinload, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å lazy loading
    await session.refresh(product, ["tags"])
    
    categories = await get_all_categories(session)
    tags = await get_all_tags(session)
    
    return templates.TemplateResponse("admin_product.html", {
        "request": request,
        "user": user,
        "product": product,  # –§–æ—Ä–º–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        "categories": categories,
        "tags": tags
    })
```

–ü–∞—Ä–∞–º–µ—Ç—Ä `product_id: int` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ URL. –î–ª—è `/products/42/edit` –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `product_id` –±—É–¥–µ—Ç —Ä–∞–≤–Ω–∞ `42`.

–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä –∏–∑ –ë–î. –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä —Å —Ç–∞–∫–∏–º ID –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 404. –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å–µ–º–∞–Ω—Ç–∏–∫–∞: "–†–µ—Å—É—Ä—Å, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—à—å, –Ω–µ –Ω–∞–π–¥–µ–Ω".

–í–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç: `await session.refresh(product, ["tags"])`. –≠—Ç–æ **eager loading** —Ç–µ–≥–æ–≤. –ë–µ–∑ —ç—Ç–æ–≥–æ, –∫–æ–≥–¥–∞ Jinja2 —à–∞–±–ª–æ–Ω –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ `product.tags` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ `{% if tag in product.tags %}`, SQLAlchemy –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è —Å–¥–µ–ª–∞—Ç—å –ª–µ–Ω–∏–≤—ã–π –∑–∞–ø—Ä–æ—Å.

–ù–æ –Ω–∞—à–∞ –º–æ–¥–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ —Å `lazy="raise_on_sql"`, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç: –ª—é–±–∞—è –ø–æ–ø—ã—Ç–∫–∞ –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤—ã–±—Ä–æ—Å–∏—Ç –æ—à–∏–±–∫—É. –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç N+1 –ø—Ä–æ–±–ª–µ–º—ã. –ú—ã –¥–æ–ª–∂–Ω—ã —è–≤–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.

`session.refresh(product, ["tags"])` –¥–µ–ª–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î, –∑–∞–≥—Ä—É–∂–∞—è —Ç–µ–≥–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞. –¢–µ–ø–µ—Ä—å `product.tags` —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ Tag, –∏ —à–∞–±–ª–æ–Ω –º–æ–∂–µ—Ç –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å.

–ü–µ—Ä–µ–¥–∞—ë–º `product=product` –≤–º–µ—Å—Ç–æ `product=None`. Jinja2 –≤–∏–¥–∏—Ç, —á—Ç–æ `product` –Ω–µ None, –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –ø–æ–ª—è —Ñ–æ—Ä–º—ã —Ç–µ–∫—É—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.

---

## üîÑ –†–æ—É—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–ß–µ—Ç–≤—ë—Ä—Ç—ã–π —Ä–æ—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç POST –æ—Ç —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –û–Ω –æ—á–µ–Ω—å –ø–æ—Ö–æ–∂ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ, –Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–≤–∞—Ä:

```python
@router.post("/products/{product_id}/edit")
async def edit_product(
    product_id: int,
    name: str = Form(...),
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è ...
    user: User = Depends(require_superuser),
    session: AsyncSession = Depends(get_session)
):
    product_orm = await session.get(ProductORM, product_id)
    if not product_orm:
        raise HTTPException(404, "–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    product_orm.name = name
    product_orm.description = description
    # ... –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π ...
    product_orm.category_id = int(category_id)
    
    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–æ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
    await session.execute(
        delete(product_tag_association).where(
            product_tag_association.c.product_id == product_id
        )
    )
    for tag_id in tag_ids:
        await session.execute(
            insert(product_tag_association).values(
                product_id=product_id, tag_id=tag_id
            )
        )
    
    await session.commit()
    return RedirectResponse("/", status_code=303)
```

–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Ö–æ–¥–∏–º —Ç–æ–≤–∞—Ä –≤ –ë–î —á–µ—Ä–µ–∑ `session.get(ProductORM, product_id)`. –≠—Ç–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–∏—Ç—å –æ–±—ä–µ–∫—Ç –ø–æ –ø–µ—Ä–≤–∏—á–Ω–æ–º—É –∫–ª—é—á—É.

–û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –∞—Ç—Ä–∏–±—É—Ç—ã –æ–±—ä–µ–∫—Ç–∞. SQLAlchemy –æ—Ç—Å–ª–µ–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî –ø–æ—Å–ª–µ `session.commit()` —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è UPDATE –∑–∞–ø—Ä–æ—Å —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –ø–æ–ª–µ–π.

–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–æ–≤ —Å–ª–æ–∂–Ω–µ–µ, –ø–æ—Ç–æ–º—É —á—Ç–æ —ç—Ç–æ many-to-many –æ—Ç–Ω–æ—à–µ–Ω–∏–µ. –ù–µ–ª—å–∑—è –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏—Å–≤–æ–∏—Ç—å `product_orm.tags = new_tags` ‚Äî –Ω—É–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ–π.

–°—Ç—Ä–∞—Ç–µ–≥–∏—è: —Å–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–≤—è–∑–∏ —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ —á–µ—Ä–µ–∑ `delete(product_tag_association)`. –ó–∞—Ç–µ–º –≤—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å–≤—è–∑–∏ —á–µ—Ä–µ–∑ `insert(product_tag_association)` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–µ–≥–∞.

–≠—Ç–æ –Ω–µ —Å–∞–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∏–∑–º–µ–Ω—è–ª —Ç–µ–≥–∏, –º—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–µ–ª–∞–µ–º delete+insert), –Ω–æ –æ–Ω –ø—Ä–æ—Å—Ç–æ–π –∏ –Ω–∞–¥—ë–∂–Ω—ã–π. –í –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö –º–æ–∂–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å: —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –∏ –Ω–æ–≤—ã–µ —Ç–µ–≥–∏, —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ, –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ.

---

## üí° –†–µ–∑—é–º–µ

–ú—ã —Å–æ–∑–¥–∞–ª–∏ –º–æ–¥—É–ª—å `routes/admin.py` —Å —á–µ—Ç—ã—Ä—å–º—è —Ä–æ—É—Ç–∞–º–∏: –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã —Å–æ–∑–¥–∞–Ω–∏—è, –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è, –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –í—Å–µ —Ä–æ—É—Ç—ã –∑–∞—â–∏—â–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å—é `require_superuser`, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏ –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞.

–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã: –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ `category_id` –∏–∑ —Å—Ç—Ä–æ–∫–∏ –≤ int, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ `tag_ids` —á–µ—Ä–µ–∑ `default=[]`, eager loading —Ç–µ–≥–æ–≤ —á–µ—Ä–µ–∑ `session.refresh` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ª–µ–Ω–∏–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ many-to-many —Å–≤—è–∑–µ–π —á–µ—Ä–µ–∑ delete+insert –≤ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ.

–ü–æ—Å–ª–µ POST-–∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å –∫–æ–¥–æ–º 303, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –í—Å–µ –æ—à–∏–±–∫–∏ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω) –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ HTTP-–∫–æ–¥–∞–º–∏ (401, 403, 404).

–í —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏ –º—ã –¥–æ–±–∞–≤–∏–º HTMX –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä—è–º–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ, –±–µ–∑ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É.
